<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Quickselect on multiple sorted arrays</title>
  <meta name="description" content="Edit: Thanks heaps to Evgeny Kluev, the author of that original StackOverflow answer, for noticing that I’d made a mistake in the total time complexity calcu...">


  <link rel="stylesheet" href="/bootstrap.css">
  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="http://bshlgrs.github.io/2016/06/15/multi-sorted-array-quickselect.html">
  <link rel="alternate" type="application/rss+xml" title="Buck Shlegeris" href="http://bshlgrs.github.io/feed.xml">
  <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      jax: ["input/TeX", "output/HTML-CSS"],
      tex2jax: {
        inlineMath: [ ['$latex', '$'] ],
        displayMath: [ ['$$', '$$']],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      },
      messageStyle: "none",
      "HTML-CSS": { preferredFont: "TeX", availableFonts: ["STIX","TeX"] }
    });
  </script>
  <script src='https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML'></script>
  <script src="/jquery.js"></script>
  <script type="text/babel" src="/main.js"></script>
  
</head>


  <body>

    

    <div class="container">
  <div class="row">
    <div class="col-sm-7 col-sm-offset-1 markdownify">
      <h1 class="post-title " itemprop="name headline">Quickselect on multiple sorted arrays</h1>
      <p class="post-meta"><time datetime="2016-06-15T00:00:00-07:00" itemprop="datePublished">Jun 15, 2016</time></p>

      <hr/>

      <p><strong>Edit: Thanks heaps to <a href="http://stackoverflow.com/users/1009831/evgeny-kluev">Evgeny Kluev</a>, the author of that original StackOverflow answer, for noticing that I’d made a mistake in the total time complexity calculation.</strong></p>

<p><strong>Edit 2016-06-18: I’d orignally described this with arrays of maximum length $latex n$. But it works just as well with arrays of average length $latex n$, which is a stronger statement, so I’d rather use this one.</strong></p>

<p>Suppose I have $latex m$ sorted arrays of average length $latex n$. How quickly can I search to find the $latex k$th item in them?</p>

<p><a href="http://stackoverflow.com/a/26299986/1360429">This StackOverflow answer</a> mentions this problem offhandedly, but doesn’t clearly explain the algorithm, and it implies that the answer it’s thinking of is $latex O(m^2 \log(n)^2)$.</p>

<p>We can do better. You can modify quickselect to get an algorithm which takes $latex O(m \log(n) \log(m \cdot n))$ average case, and I suspect you can adapt <a href="https://en.wikipedia.org/wiki/Median_of_medians">median of medians</a> to get that time in the worst case.</p>

<p>The quickselect adaptation is pretty simple. We’re going to be do a simultaneous binary search on every array. For simplicity, let’s assume that all items in arrays are unique.</p>

<p>We’re going to need a <code class="highlighter-rouge">rank</code> method, which does a binary search to determine the number of items in an array smaller than its argument <code class="highlighter-rouge">x</code>. Here is such a method:</p>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="c1"># Returns the number of items in arr smaller than x.</span>
<span class="k">def</span> <span class="nf">rank</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">start_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">end_idx</span> <span class="o">=</span> <span class="kp">nil</span><span class="p">)</span>
  <span class="k">return</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">arr</span><span class="p">.</span><span class="nf">empty?</span>

  <span class="n">end_idx</span> <span class="o">=</span> <span class="n">arr</span><span class="p">.</span><span class="nf">length</span> <span class="k">if</span> <span class="n">end_idx</span><span class="p">.</span><span class="nf">nil?</span>

  <span class="c1"># this makes sense I promise, I'll explain later</span>
  <span class="k">return</span> <span class="n">arr</span><span class="p">.</span><span class="nf">length</span> <span class="k">if</span> <span class="n">start_idx</span> <span class="o">==</span> <span class="n">arr</span><span class="p">.</span><span class="nf">length</span>
  <span class="k">return</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">end_idx</span> <span class="o">==</span> <span class="mi">0</span>

  <span class="kp">loop</span> <span class="k">do</span>
    <span class="n">mid_idx</span> <span class="o">=</span> <span class="p">((</span><span class="n">start_idx</span> <span class="o">+</span> <span class="n">end_idx</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">).</span><span class="nf">floor</span>

    <span class="k">if</span> <span class="n">arr</span><span class="p">[</span><span class="n">mid_idx</span><span class="p">]</span> <span class="o">==</span> <span class="n">x</span>
      <span class="k">return</span> <span class="n">mid_idx</span>
    <span class="k">elsif</span> <span class="n">arr</span><span class="p">[</span><span class="n">mid_idx</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">x</span>
      <span class="k">return</span> <span class="n">start_idx</span> <span class="k">if</span> <span class="n">end_idx</span> <span class="o">-</span> <span class="n">start_idx</span> <span class="o">&lt;=</span> <span class="mi">1</span>
      <span class="n">end_idx</span> <span class="o">=</span> <span class="n">mid_idx</span>
    <span class="k">else</span>
      <span class="k">return</span> <span class="n">end_idx</span> <span class="k">if</span> <span class="n">end_idx</span> <span class="o">-</span> <span class="n">start_idx</span> <span class="o">&lt;=</span> <span class="mi">1</span>
      <span class="n">start_idx</span> <span class="o">=</span> <span class="n">mid_idx</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Now here’s how the select method is going to work. We’re going to start by setting up a <code class="highlighter-rouge">limits</code> variable. Normally in binary search, you need to store two variables, <code class="highlighter-rouge">start_idx</code> and <code class="highlighter-rouge">end_idx</code>. In our case, we’re going to store these two variables for every array we’re working with.</p>

<p>Every iteration, we’re going to randomly choose a pivot from the elements that haven’t been ruled out yet. Then we’re going to binary search all of the arrays to find the rank of the pivot in each of the arrays. We can add all these ranks together to find the rank of the pivot overall.</p>

<p>If the rank of the pivot is equal to <code class="highlighter-rouge">k</code>, then we return our pivot and stop recursing.</p>

<p>If the rank of the pivot is greater than <code class="highlighter-rouge">k</code>, our pivot is larger than the true result. So we can rule out every value which is larger than our pivot. For every array, we set its <code class="highlighter-rouge">end_idx</code> to the rank which it computed for the pivot.</p>

<p>If the rank of the pivot is smaller than k, then do the opposite: set the <code class="highlighter-rouge">start_idx</code> array to the rank array.</p>

<p>Here’s an implementation of that:</p>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="k">def</span> <span class="nf">quickselect_in_sorted_arrays</span><span class="p">(</span><span class="n">arrays</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">arrays</span><span class="p">.</span><span class="nf">first</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">if</span> <span class="n">arrays</span><span class="p">.</span><span class="nf">length</span> <span class="o">==</span> <span class="mi">1</span>

  <span class="n">arrays</span><span class="p">.</span><span class="nf">select!</span> <span class="p">{</span> <span class="o">|</span><span class="n">x</span><span class="o">|</span> <span class="n">x</span><span class="p">.</span><span class="nf">length</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">}</span>

  <span class="k">return</span> <span class="kp">nil</span> <span class="k">if</span> <span class="n">k</span> <span class="o">&gt;=</span> <span class="n">arrays</span><span class="p">.</span><span class="nf">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:count</span><span class="p">).</span><span class="nf">reduce</span><span class="p">(</span><span class="o">&amp;</span><span class="p">:</span><span class="o">+</span><span class="p">)</span>

  <span class="c1"># In a single binary search, we have variables `start_idx`</span>
  <span class="c1"># and `end_idx`.</span>

  <span class="c1"># In this binary search, we need those variables for</span>
  <span class="c1"># every array. So we'll keep them in these arrays.</span>
  <span class="n">start_indexes</span> <span class="o">=</span> <span class="n">arrays</span><span class="p">.</span><span class="nf">map</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">}</span>
  <span class="n">end_indexes</span> <span class="o">=</span> <span class="n">arrays</span><span class="p">.</span><span class="nf">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">arr</span><span class="o">|</span> <span class="n">arr</span><span class="p">.</span><span class="nf">length</span> <span class="p">}</span>

  <span class="kp">loop</span> <span class="k">do</span>
    <span class="c1"># Randomly select an item from the viable candidates.</span>
    <span class="c1"># (This is obviously not an efficient implementation)</span>
    <span class="n">pivot</span> <span class="o">=</span> <span class="n">arrays</span><span class="p">.</span><span class="nf">map</span>
                  <span class="p">.</span><span class="nf">with_index</span> <span class="k">do</span> <span class="o">|</span><span class="n">arr</span><span class="p">,</span> <span class="n">idx</span><span class="o">|</span>
                    <span class="n">arr</span><span class="p">[</span><span class="n">start_indexes</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">end_indexes</span><span class="p">[</span><span class="n">idx</span><span class="p">]]</span>
                  <span class="k">end</span>
                  <span class="p">.</span><span class="nf">flatten</span>
                  <span class="p">.</span><span class="nf">sample</span>


    <span class="c1"># Find the rank of the pivot in every array.</span>
    <span class="n">pivot_ranks</span> <span class="o">=</span> <span class="n">arrays</span><span class="p">.</span><span class="nf">map</span><span class="p">.</span><span class="nf">with_index</span> <span class="k">do</span> <span class="o">|</span><span class="n">arr</span><span class="p">,</span> <span class="n">idx</span><span class="o">|</span>
      <span class="n">rank</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">pivot</span><span class="p">,</span> <span class="n">start_indexes</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">end_indexes</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
    <span class="k">end</span>

    <span class="c1"># What is `pivot`'s overall rank in these arrays?</span>
    <span class="n">overall_rank_of_pivot</span> <span class="o">=</span> <span class="n">pivot_ranks</span><span class="p">.</span><span class="nf">reduce</span><span class="p">(</span><span class="o">&amp;</span><span class="p">:</span><span class="o">+</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">overall_rank_of_pivot</span> <span class="o">==</span> <span class="n">k</span>
      <span class="c1"># we're done! woohoo!</span>
      <span class="k">return</span> <span class="n">pivot</span>
    <span class="k">elsif</span> <span class="n">overall_rank_of_pivot</span> <span class="o">&gt;</span> <span class="n">k</span>
      <span class="c1"># our pivot was apparently too big.</span>

      <span class="c1"># On the plus side, we now know that wherever our binary</span>
      <span class="c1"># searches just finished, everything to the right of that</span>
      <span class="c1"># in that array is now guaranteed not to be the result.</span>
      <span class="n">pivot_ranks</span><span class="p">.</span><span class="nf">each_with_index</span> <span class="k">do</span> <span class="o">|</span><span class="n">rank</span><span class="p">,</span> <span class="n">idx</span><span class="o">|</span>
        <span class="n">end_indexes</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">rank</span>
      <span class="k">end</span>
    <span class="k">else</span>
      <span class="c1"># If our pivot was too small, then we can rule out</span>
      <span class="c1"># everything to the left of those ranks.</span>
      <span class="n">pivot_ranks</span><span class="p">.</span><span class="nf">each_with_index</span> <span class="k">do</span> <span class="o">|</span><span class="n">rank</span><span class="p">,</span> <span class="n">idx</span><span class="o">|</span>
        <span class="n">start_indexes</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">rank</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>For full source code including some random testcases, <a href="https://gist.github.com/bshlgrs/14801efbb27d447fa7a2afba97ab70b4">look here</a>.</p>

<p>How fast is this method? The main loop costs $latex m \log(n)$ per iteration. How many times will we run it? Well, every time we run the iteration, we cut out all the elements which are on the wrong side of the result from our pivot. Worst case, we keep choosing the worst possible pivot and only ruling it out, which means we need to run that iteration once for every item in all of the arrays. This is $latex O(m^2 n \log(n))$.</p>

<p>But on average, we’ll cut a constant fraction of our search space out every time. So we should expect to have to do that iteration $latex \log(m\cdot n) = \log(m) + \log(n)$ times, for an overall time complexity of $latex O(m \log(n) \log(m \cdot n))$.</p>

<p>(Incidentally, when I was initially thinking about this, I thought we might get some speedup because our call to <code class="highlighter-rouge">rank</code> is going to be on a smaller and smaller section of its array every iteration throuhgh the loop. But I don’t think that’s true, because to get an asympotic decrease in the sum of a bunch of logarithms, you need to make your problem sizes decrease extremely quickly; exponentially decaying problem size doesn’t cut it. For example:</p>

<script type="math/tex; mode=display">O\left(\sum_{i=0}^n \log\left(2^i\right) \right) = O(\log(n)^2) = O\left(\sum_{i=0}^n \log\left(2^n\right) \right)</script>

<p>because</p>

<script type="math/tex; mode=display">O\left(\sum_{i=0}^n i \right) = O(n^2) = O\left(\sum_{i=0}^n n \right)</script>

<p>So I don’t think we can make that work.)</p>

<h2 id="further-questions">Further questions</h2>

<ul>
  <li>Can we generalize the <a href="https://en.wikipedia.org/wiki/Median_of_medians">median of medians</a> algorithm to get this to be guaranteed fast, rather than expected fast? The answer is almost certainly yes; I’ll probably try to prove it sometime.</li>
</ul>


      <hr/>

<div class="PageNavigation">
  
    <a class="prev" href="/2016/06/12/quickselect-lemma.html">&laquo; Quickselect on an unordered array and an order statistic tree</a>
  
  
    <a class="pull-right" href="/2016/06/16/generalized-multi-quickselect.html">Generalized multi-quickselect &raquo;</a>
  
</div>

    </div>
    <div class="col-sm-3 col-sm-offset-1">
      <img src="https://scontent-sjc2-1.xx.fbcdn.net/hphotos-xtp1/t31.0-8/11154688_10205041372168719_3725604149367069581_o.jpg" class="img-responsive" alt="Picture of Buck">
      
<hr/>
<a class="arrow" href="/"><strong>Buck</strong></a>
<ul>
  <li><a class="arrow" href="/about">About</a></li>
  <li>Links
    <ul>
      <li>
          <a class="arrow" href="http://github.com/bshlgrs">GitHub</a>
      </li>
      <li>
          <a class="arrow" href="mailto:bshlegeris@gmail.com">Email</a>
      </li>
      <li>
          <a class="arrow" href="http://www.facebook.com/bshlgrs">Facebook</a>
      </li>
      <li>
          <a class="arrow" href="http://lnkd.in/bnBJ6EF">LinkedIn</a>
      </li>
      <li>
          <a class="arrow" href="/resume.pdf">Resume</a>
      </li>
    </ul>
  </li>
  <li><a class="arrow external" href="https://docs.google.com/forms/d/1SOombLPHlKIMut-wJzIRg7DGdJjh9PJV4yAkrmTXKn4/viewform?usp=send_form">Anonymous feedback</a></li>

  <li><a href="/posts" class="arrow">Blog</a>
    <ul>
      
        <li>
          <a class="arrow" href="/2016/06/16/kth-richest.html">A data structure for answering 'who is the kth richest person with age between x and y'</a>
        </li>
      
        <li>
          <a class="arrow" href="/2016/06/16/generalized-multi-quickselect.html">Generalized multi-quickselect</a>
        </li>
      
        <li>
          <a class="arrow" href="/2016/06/15/multi-sorted-array-quickselect.html">Quickselect on multiple sorted arrays</a>
        </li>
      
        <li>
          <a class="arrow" href="/2016/06/12/quickselect-lemma.html">Quickselect on an unordered array and an order statistic tree</a>
        </li>
      
        <li>
          <a class="arrow" href="/2016/06/02/say.html">Not thinking of things I can't say</a>
        </li>
      
        <li>
          <a class="arrow" href="/2016/05/29/explicit.html">Optimize dating for non-interference with platonic relationships</a>
        </li>
      
        <li>
          <a class="arrow" href="/2016/05/29/flinching.html">Flinching away from hard things</a>
        </li>
      
        <li>
          <a class="arrow" href="/2016/05/24/mistakes.html">My main effective altruism mistakes so far</a>
        </li>
      
    </ul>
  </li>
  <li>
      <a class="arrow" href="/cute">Pictures of me</a>
  </li>
</ul>

    </div>
  </div>
</div>




    <footer class="site-footer">

  <div class="wrapper">

    <h2 class="footer-heading">Buck Shlegeris</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li>Buck Shlegeris</li>
          <li><a href="mailto:bshlegeris@gmail.com">bshlegeris@gmail.com</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/bshlgrs"><span class="icon icon--github"><svg viewBox="0 0 16 16"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/></svg>
</span><span class="username">bshlgrs</span></a>

          </li>
          

          
          <li>
            <a href="https://twitter.com/bshlgrs"><span class="icon icon--twitter"><svg viewBox="0 0 16 16"><path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/></svg>
</span><span class="username">bshlgrs</span></a>

          </li>
          
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p>Website of Buck Shlegeris.
</p>
      </div>
    </div>

  </div>

</footer>


  </body>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-52980069-1', 'auto');
  ga('send', 'pageview');

</script>

</html>

