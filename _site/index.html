<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">

  <title>Buck Shlegeris</title>
  <meta name="description" content="Website of Buck Shlegeris.
">

  <link rel="stylesheet" href="/bootstrap.css">
  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="http://localhost:4000/">
  <link rel="alternate" type="application/rss+xml" title="Buck Shlegeris" href="http://localhost:4000/feed.xml">
  <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      jax: ["input/TeX", "output/HTML-CSS"],
      tex2jax: {
        inlineMath: [ ['$$', '$$'] ],
        displayMath: [ ['$^$', '$^$']],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      },
      messageStyle: "none",
      "HTML-CSS": { preferredFont: "TeX", availableFonts: ["STIX","TeX"] }
    });
  </script>
  <script src='https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML'></script>
  <script src="/jquery.js"></script>
  <script type="text/babel" src="/main.js"></script>
  
</head>


  <body>

    

    <div class="container">
  <div class="row">
    <div class="col-sm-3 hidden-xs">
      <img src="/img/dual_n_buck.jpeg" class="img-responsive" alt="Picture of Buck" height="213" width="213">
<hr/>
<a class="arrow" href="/"><strong>Buck</strong></a>
<ul>
  <li><a class="arrow" href="/about">About</a>
    <ul>
      <li><a href="http://triplebyte.com?ref=shlegeris.com">Triplebyte</a></li>
    </ul>
  </li>
  <li>Links
    <ul>
      <li>
          <a class="arrow" href="http://github.com/bshlgrs">GitHub</a>
      </li>
      <li>
          <a class="arrow" href="mailto:bshlegeris@gmail.com">Email</a>
      </li>
      <li>
          <a class="arrow" href="http://www.facebook.com/bshlgrs">Facebook</a>
      </li>
      <li>
          <a class="arrow" href="http://lnkd.in/bnBJ6EF">LinkedIn</a>
      </li>
    </ul>
  </li>
  <li><a class="arrow external" href="/anonymous_feedback">Anonymous feedback</a></li>
  <li>Software to play with
    <ul>
      <li>
          <a class="arrow" href="http://ds.shlegeris.com/">Data structure search engine</a>
      </li>
      <li>
          <a class="arrow" href="https://bshlgrs.github.io/music-game/">Relative pitch game</a>
      </li>
      <li>
          <a class="arrow" href="http://shlegeris.com/gini">Gini coefficient tool</a>
      </li>
      <li>
          <a class="arrow" href="http://shlegeris.com/dice">Extremely serious election probability tool</a>
      </li>
    </ul>
  </li>
  <li><a href="/posts" class="arrow">Blog</a> (<a href="/best" class="arrow">Best posts</a>) (<a href="/feed.xml">RSS</a>)
    <ul>
      
        <li>
          <a class="arrow" href="/2016/11/26/research.html">How much of a paperclip maximizer's resources should be spend on research?</a>
        </li>
      
        <li>
          <a class="arrow" href="/2016/11/13/phd.html">Advice on whether you should get a PhD in engineering</a>
        </li>
      
        <li>
          <a class="arrow" href="/2016/11/13/ds.html">Building a search engine for data structures</a>
        </li>
      
        <li>
          <a class="arrow" href="/2016/10/23/poor-college-graduates.html">Poor college graduates do much better than rich high-school dropouts</a>
        </li>
      
        <li>
          <a class="arrow" href="/2016/10/20/libertarians.html">Left-libertarianism</a>
        </li>
      
        <li>
          <a class="arrow" href="/2016/10/07/optimal-tax.html">Optimal redistribution with a flat tax</a>
        </li>
      
        <li>
          <a class="arrow" href="/2016/10/02/ubi.html">Universal basic incomes disincentivise work</a>
        </li>
      
        <li>
          <a class="arrow" href="/2016/10/02/tax.html">The great thing about regressive taxes</a>
        </li>
      
    </ul>
  </li>
  <li>
      <a class="arrow" href="/to-prove-list">My "to-prove" list</a>
  </li>
  <li>
      <a class="arrow" href="/mistakes">Mistakes</a>
  </li>
  <li>
      <a class="arrow" href="/cute">Pictures of me</a>
  </li>
</ul>

    </div>

    <div class="col-sm-7 col-sm-offset-1 markdownify">
      
      <p class="post-meta"><time datetime="1969-12-31T16:00:00-08:00" itemprop="datePublished"></time></p>

      <hr/>

      <h1>Buck Shlegeris</h1>

<div class="lead">
<p>I am a software engineer from Australia. I have lived in San Francisco for most of the last three years. I'm interested in data structures, economics, and effective altruism.</p>
<p><a href="/best">Here</a> are the most interesting things I've written. My most notable software project is <a href="http://ds.shlegeris.com">a search engine for data structures</a>.</p>
<p>If, <a href="http://www.overcomingbias.com/2008/03/against-news.html">like many</a>, you prefer to consume content ordered by recency rather than quality, here are some things I wrote recently:</p>
</div>


  <div class="buck-post">
    <h2><a href="/2016/11/26/research.html"> How much of a paperclip maximizer's resources should be spend on research?</a></h2>

    <p class="post-meta"><time datetime="2016-11-26T00:00:00-08:00" itemprop="datePublished">Nov 26, 2016</time></p>

    <div class="shrink-headings">
      <p>Suppose you’re a paperclip maximizer who has just finished exterminating humanity. You want to build as many paperclips as you can. This involves two activities: researching how to build paperclips as efficiently as possible, and then executing on the optimal manufacturing technique that you’ve discovered.</p>

<p>Research has diminishing marginal returns. When I started thinking about this, my guess was that the proportion of your effort you’d spend on research would decrease quickly as you increased the amount of resources you control.</p>

<p>But then I tried making a mathematical model for it and now I don’t think that anymore.</p>

<h2 id="logarithmic-returns">Logarithmic returns</h2>

<p>Suppose the returns to thinking are logarithmic. Maybe the cost of manufacturing a paperclip after you’ve expended <script type="math/tex">r</script> effort on researching paperclip manufacturing is <script type="math/tex">\frac{1}{\log(r)}</script>. Now if you have <script type="math/tex">x</script> total resources, the total paperclip manufacture you get done is</p>

<p>$^$\frac{x - r}{\log(r)}$^$</p>

<p>which you can solve to get the optimal value of <script type="math/tex">r</script> (full working <a href="https://github.com/bshlgrs/economics-demos/blob/master/python/paperclip.py">here</a>):</p>

<p>$^$ e^{\operatorname{LambertW}{\left (e \cdot x \right )} - 1} $^$</p>

<p>Not gonna lie, I had to look up what the Lambert W function is. It’s asymptotially equal to <script type="math/tex">\log(x) - \log(\log(x)) + o(1)</script>. So overall we have</p>

<script type="math/tex; mode=display">% <![CDATA[
\begin{align}
   e^{\operatorname{LambertW}{\left (e \cdot x \right )} - 1} &= e^{\log(e \cdot x) - \log(\log(e \cdot x)) + o(1) - 1} \\
 &= \frac{e \cdot x}{\log(e \cdot x)} \cdot o(1)
\end{align} %]]></script>

<p>So the proportion of energy dedicated to research increases like <script type="math/tex">\frac{x}{\log(x)}</script>.</p>

<p>Here’s a table of some values of the solution:</p>

<table class="table">
  <thead>
    <tr>
      <td>$$x$$</td><td>$$r$$</td>
    </tr>
  </thead>
  <tbody>
<tr><td> $$10^0$$ </td><td> 1.0 </td></tr>
<tr><td> $$10^1$$ </td><td> 4.13</td></tr>
<tr><td> $$10^2$$ </td><td> 23.9 </td></tr>
<tr><td> $$10^3$$ </td><td> 164 </td></tr>
<tr><td> $$10^4$$ </td><td> 1232 </td></tr>
<tr><td> $$10^5$$ </td><td> 9812 </td></tr>
<tr><td> $$10^6$$ </td><td> 81264 </td></tr>
<tr><td> $$10^7$$ </td><td> 692157 </td></tr>
<tr><td> $$10^8$$ </td><td> 6020238 </td></tr>
<tr><td> $$10^{20}$$ </td><td> 2.310e+18</td></tr>
<tr><td> $$10^{50}$$ </td><td> 8.975e+47 </td></tr>
<tr><td> $$10^{100}$$ </td><td> 4.428e+97 </td></tr>
<tr><td> $$10^{200}$$ </td><td> 2.196e+197 </td></tr>
</tbody>
</table>

<h2 id="other-functional-forms-for-returns-to-research">Other functional forms for returns to research</h2>

<p>If returns diminish more slowly than logarithmically, eg if your cost function is <script type="math/tex">\frac{1}{\sqrt{r}}</script>, you end up spending a larger fraction of your resources on research–in that particular case, you spend exactly <script type="math/tex">\frac13</script> on research. More generally, the cost function <script type="math/tex">\frac{1}{\sqrt[p]{r}}</script> has an optimal research expenditure of <script type="math/tex">\frac{1}{p + 1}\cdot x</script>.</p>

<p>If returns diminish more quickly than logarithmically, you spend less on research. But not that much. I can’t find a closed form solution for the case where paperclip cost looks like <script type="math/tex">frac{1}{\log(\log(r))}</script>, but when I <a href="https://github.com/bshlgrs/economics-demos/blob/master/python/paperclip_log_log.py">solve it numerically</a>, research expenditure looks only slightly slower growing than it was in the log case.</p>

<h2 id="could-returns-to-research-ever-hit-literally-zero">Could returns to research ever hit literally zero?</h2>

<p>I don’t see any obvious reasons that they would, but I guess it could happen. Even if they did, you’d have to be extremely confident that you were never going to get anything useful out of research in order to stop doing it.</p>

<h2 id="conclusion">Conclusion</h2>

<p>Given that research spending is a reasonably large proportion of industry now, and that research looks like it should grow almost proportionally with your overall resource budget even when you have extremely large amounts of resources, I think that a paperclipper would probably continue to spend a noticeable proportion of its resources on optimizing its existing processes.</p>


    </div>
  </div>

  <div class="buck-post">
    <h2><a href="/2016/11/13/phd.html"> Advice on whether you should get a PhD in engineering</a></h2>

    <p class="post-meta"><time datetime="2016-11-13T00:00:00-08:00" itemprop="datePublished">Nov 13, 2016</time></p>

    <div class="shrink-headings">
      <p>Lewis Collins, who I incidentally first met when I was eleven, recently asked me for some advice about whether he should get do a PhD in mechatronic engineering. I ended up writing about PhDs more generally. I’m interested in the thoughts of people who have experience with this stuff. Here’s what I wrote.</p>

<p>A disclaimer: I know about software engineering and a few other nearby fields, but not mechatronic engineering. I’ve slightly reorganized your questions.</p>

<blockquote>
  <p>So I just got offered a PhD scholarship in mechatronic engineering at the University of Sydney. I’ve been trying to weigh up whether it’s worth it for me, and one of the major reasons for doing it would be the chance to work at a high level in R&amp;D at an American tech company or a start up.</p>

  <p>What I was hoping you’d be able to help me with, is gauging how much of a benefit having a PhD would be in the labour market over there.</p>

  <p>What would be the type of role I would be looking at, would it be entry level (the same as a bachelor graduate) or would a PhD give me the chance to work at a bit of a higher level straight out?</p>
</blockquote>

<p>I can’t speak to mechatronic engineering. Here’s how I would have answered if you asked me that question about computer science PhDs.</p>

<p>Computer science PhDs are not very relevant to the majority of software engineering jobs. Around here, you would be much better off with three years software engineering experience than a PhD, if your goal is to work at most of the most prestigious Silicon Valley companies. A PhD is probably the equivalent of about one year’s experience in terms of how much companies like it.</p>

<p>This obviously varies by field. Let’s talk about three different fields: distributed systems, machine learning, and programming language implementation.</p>

<p>Distributed systems—that is, building really large web systems which work for giant Internet companies like Google or Facebook or whatever—is one of the most highly paid disciplines in software. The state of the art in industry is miles ahead of academia, so you’re much better off studying that in industry. And there are lots of software jobs which involve building large web systems, so if you want to get experience in the field it’s really easy to do so in industry (assuming you’re a good engineer, but not assuming that you spent much time studying distributed systems specifically). If you want a really top distributed systems job, you’re definitely better off by going straight into industry.</p>

<p>On the other side of the spectrum, I know a lot of people who want to transition from software engineering to machine learning work. Because ML is so cool right now, it’s quite difficult for them to make that transition. It’s much easier to get a good ML job with a PhD in ML than with a few years’ software engineering experience. So the PhD is absolutely the right path there. However, if you can find some way of breaking into industry without the PhD, that might be the best path of all. (That’s risky though: companies sometimes tell potential employees that they’ll be doing really interesting ML, then give them other tasks once they get there.)</p>

<p>Programming language implementation is another interesting case. Unlike distributed systems, programming language implementation is an extremely academic field, and lots of research is done within academia. However, big companies also work on this, because it’s relevant to their businesses—for example, all the major browsers spend very large amounts of money making fast Javascript engines. The heads of these projects usually have academic experience, but it’s quite easy to get a job working on this stuff without that academic background—Apple offered me a job working on Safari’s JS engine last year without me really talking to them about programming language implementation much at all, they just wanted me to demonstrate that I’m a fast and competent programmer. So it seems plausible that even in that fairly academic field, I would have been better off spending time in industry than doing a PhD.</p>

<blockquote>
  <p>Do companies see PhD’s as a bonus or more of a hindrance? I have read that some companies don’t like how specialized PhD’s can be, and they see lack of industry experience as a weakness.</p>
</blockquote>

<p>This varies strongly by company. If you’re trying to get a job as a specialist in the field which you got your PhD in, obviously the PhD will be helpful. If you’re trying to get a generalist position, companies will consider it to be something between a mild advantage and a mild disadvantage.</p>

<p>Again, companies would usually usually prefer industry experience to academic experience, except in the most academic fields. So if you have a way of sneaking into industry, it’s worth seeking that out.</p>

<p>Mechatronics seems like it might be more credentials based than software engineering, because good software engineers are in such high demand that companies have had to learn to deal with people with weird backgrounds, and I have the weak impression that mechatronics might mostly happen at older and less flexible companies.</p>

<blockquote>
  <p>Also how big of a disadvantage is being Australian? I can imagine getting sponsored visas and all that is a major downside for a company.</p>
</blockquote>

<p>It’s easy for Australians to get visas. I wouldn’t worry about that, unless Trump fucks with the relevant regulations, which I suspect won’t happen.</p>

<blockquote>
  <p>I know all that you can offer me is incredibly general advice but it’s better than none, I’m just trying to work out all my options before I decide to dedicate 3 years into this…</p>
</blockquote>

<p>I think people almost always spend insufficient time trying to decide whether they should make big decisions like this. I reckon you should try to talk to at least one person who makes hiring decisions for the kind of roles you’d be trying to get after the PhD, and several people who got into the kind of jobs you want, one way or another.</p>


    </div>
  </div>

  <div class="buck-post">
    <h2><a href="/2016/11/13/ds.html"> Building a search engine for data structures</a></h2>

    <p class="post-meta"><time datetime="2016-11-13T00:00:00-08:00" itemprop="datePublished">Nov 13, 2016</time></p>

    <div class="shrink-headings">
      <p>Today I <a href="https://scalaebythebay2016.sched.org/event/7iUk/automatic-composition-of-fast-data-structures">presented at Scala By The Bay</a> about my project to build a search engine for data structures. I’ve deployed the project at <a href="http://ds.shlegeris.com">ds.shlegeris.com</a>; you can play with it there. You can also read the source code <a href="https://github.com/bshlgrs/data-structure-composer">on Github</a>.</p>

<p>This blog post is a more detailed version of the talk I gave today.</p>

<h2 id="a-search-engine-for-data-structures">A search engine for data structures</h2>

<p>A data structure is a way of organizing data to efficiently support a particular API. So a data structure search engine is a program which takes an API and returns an efficient implementation.</p>

<p>Let’s look at some examples of queries that the search engine is able to support. Here’s one from Cracking the Coding Interview:</p>

<p><img class="shadow-img" src="/img/sbtb/ctci.png" /></p>

<p>You can see the answer my software finds <a href="http://ds.shlegeris.com/#getLast,deleteLast!,insertLast!,getMinimum">here</a>.</p>

<p>Here’s one from Quora:</p>

<p><img class="shadow-img" src="/img/sbtb/quora1.png" /></p>

<p>And <a href="http://ds.shlegeris.com/#getMinimum,getMaximum,deleteMaximum!,deleteMinimum!,deleteFirstNodeWithValue!,insertAnywhere!">here’s my answer</a>.</p>

<p>Here’s a third Quora question:</p>

<p><img class="shadow-img" src="/img/sbtb/quora2.png" /></p>

<p><a href="http://ds.shlegeris.com/#getFirst,deleteFirst!,insertLast!,deleteAtIndex!">And my answer</a>.</p>

<p>The pattern here is that we are being asked to choose a fast data structure to support a given set of methods. I’m going to call that set of methods an <a href="https://en.wikipedia.org/wiki/Abstract_data_type">abstract data type</a>, or ADT for short.</p>

<h2 id="implementation">Implementation</h2>

<p>The whole project is built around a bank of knowledge about data structures and the relationships between different methods.</p>

<p>The core algorithm is something like the following pseudocode:</p>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code><span class="k">def</span> <span class="n">chooseFastDataStructuresForAdt</span><span class="o">(</span><span class="n">adt</span><span class="k">:</span> <span class="kt">AbstractDataType</span><span class="o">)</span><span class="k">:</span> <span class="kt">Set</span><span class="o">[</span><span class="kt">DataStructureChoice</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
  <span class="k">val</span> <span class="n">options</span><span class="k">:</span> <span class="kt">Set</span><span class="o">[</span><span class="kt">DataStructureChoice</span><span class="o">]</span> <span class="k">=</span>
    <span class="n">allDataStructures</span><span class="o">.</span><span class="n">subsets</span>
                     <span class="o">.</span><span class="n">map</span><span class="o">((</span><span class="n">subset</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">findAllTimes</span><span class="o">(</span><span class="n">subset</span><span class="o">,</span> <span class="n">adt</span><span class="o">))</span>

  <span class="n">adt</span><span class="o">.</span><span class="n">pickBestCompositeDataStructures</span><span class="o">(</span><span class="n">options</span><span class="o">)</span>
<span class="o">}</span>
</code></pre>
</div>

<p>So we compute the times taken for all the methods by each possible composite data structure. Then we choose the best data structures for our use case.</p>

<!--
<p>
### Aside: Dominance frontiers

One type that I use a lot in this code is what I'm calling a `DominanceFrontier`, for lack of a better name. A dominance frontier is a set of items `A` with a partial ordering on them, such that no item is strictly dominated by any other. For example, in the type of algebraic expressions with free variables $$x$$ and $$y$$ where our partial ordering is based on their asymptotic growth, I might have the set $$\{x + y, x \log(x), y^2\}$$, because no element is strictly less than any other. However, I couldn't add $$\{x\}$$ to that set, because it's not asymptotically greater than $$\{x + y\}$$.

`DominanceFrontier` is a monad over the category of partially ordered Scala objects (if you count Set as a monad). It's a super useful abstraction over the idea of doing a search for the optimal solutions for some problem, and wanting to maintain all plausible subsolutions along the way.
</p> -->

<h3 id="inference-on-method-implementations">Inference on method implementations</h3>

<p>To do this kind of inference, we need to be able to evaluate the runtimes of all methods of a particular composite data structure. Let’s look at how that works.</p>

<p>Throughout this whole thing I’m going to assume we’re talking about methods on an ordered list.</p>

<p>We need to talk about lots of different methods, like <code class="highlighter-rouge">getFirst</code>, <code class="highlighter-rouge">getNext</code>, <code class="highlighter-rouge">getByIndex</code>. These are redundant on purpose. In an array, it’s natural to define <code class="highlighter-rouge">getByIndex</code> and derive <code class="highlighter-rouge">getFirst</code> and <code class="highlighter-rouge">getNext</code> from that. In a linked list, the other way round is nicer.</p>

<p>We will describe the read methods of an ArrayList like this:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>ds ArrayList {
  getByIndex &lt;- 1
}
</code></pre>
</div>

<p>And a linked list will look like this:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>ds LinkedList {
  getNext &lt;- 1
  getFirst &lt;- 1
}
</code></pre>
</div>

<p>The central relationship that we care about is how implementations can be used to implement other things. Let’s make some rules like that:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>getByIndex &lt;- getFirst + n * getNext
getFirst &lt;- getByIndex
getNext &lt;- getByIndex
</code></pre>
</div>

<p>So you can implement <code class="highlighter-rouge">getByIndex</code> with O(1) calls to <code class="highlighter-rouge">getFirst</code> and O(n) calls to <code class="highlighter-rouge">getNext</code>. You can also implement <code class="highlighter-rouge">getFirst</code> or <code class="highlighter-rouge">getNext</code> with O(1) calls to <code class="highlighter-rouge">getByIndex</code>.</p>

<p>Facts of this type are called ‘implementations’ in my system; they have the class <code class="highlighter-rouge">Impl</code>. Implementations can either belong to data structures, like <code class="highlighter-rouge">getByIndex &lt;- 1</code> above, or they can be universally true, like <code class="highlighter-rouge">getByIndex &lt;- getFirst + n * getNext</code>.</p>

<p>There’s a useful distinction between implementations with free variables (like <code class="highlighter-rouge">f &lt;- g</code>) and those without (<code class="highlighter-rouge">f &lt;- 1</code>). I call the former type free and the latter type bound. Bound implementations are a subset of free implementations. I represent these with the classes FreeImpl and BoundImpl. (These names aren’t great, I’d be happy to hear suggestions for better ones. In lambda calculus a term with no free variables is called a combinator, but almost no-one would actually think that’s an intuitive term for what I’m talking about here.)</p>

<h5 id="parameterization">Parameterization</h5>

<p>Additional complexity comes from the fact that implementations can be parameterized, and can have conditions attached to their parameters. For example, the method <code class="highlighter-rouge">reduce[f]</code> is parameterized by the function it’s reducing. The difference between a method being parameterized and it taking an argument is that the parameter must be known at the time of data structure initialization.</p>

<p>For example, if I want to have a list which maintains its sum, I can just store the sum as an Int somewhere, and add new values to my sum as they’re inserted and subtract them as they’re removed. This is possible because <code class="highlighter-rouge">+</code> is invertible. So I want to be able to write down a data structure for maintaining this kind of reduction. (simplified from <a href="https://github.com/bshlgrs/data-structure-composer/blob/d18a104400e214e589cefb72f8d466b97ae44c5f/data/data_structures/InvertibleReductionMemoizer.txt">here</a>)</p>

<div class="highlighter-rouge"><pre class="highlight"><code>ds InvertibleReductionMemoizer[f] if f.invertible {
    reduce[f] &lt;- 1
    insertLast! &lt;- 1
    deleteLast! &lt;- 1

    // you can do this anywhere if the
    insertAtIndex! if f.commutative &lt;- 1
    updateNode! if f.commutative &lt;- 1
    deleteNode! if f.commutative &lt;- 1
}
</code></pre>
</div>

<p>This data structure lets you push and pop values and maintains the reduction for any invertible function <code class="highlighter-rouge">f</code>. In addition, if <code class="highlighter-rouge">f</code> is commutative, you’re allowed to do random modifications to the list.</p>

<p>These constraints need to be propogated through the code. For example, my code contains these implementations:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>getMinimum &lt;- getFirstBy[valueOrdering]
getFirstBy[f] &lt;- reduce[_{commutative, idempotent} &lt;- f]
</code></pre>
</div>

<p>The <code class="highlighter-rouge">getFirstBy</code> implementation means that you can implement <code class="highlighter-rouge">getFirstBy[f]</code> by using <code class="highlighter-rouge">reduce</code> with a parameter which is commutative and idempotent, and which requires calling <code class="highlighter-rouge">f</code> every time it is called.</p>

<p>We still have the distinction between free and bound implementations: <code class="highlighter-rouge">f[x] &lt;- x</code> is bound and <code class="highlighter-rouge">f[y] &lt;- z</code> is free.</p>

<h4 id="searching-through-implementations">Searching through implementations</h4>

<p>To search for method times for a given data structure, we start out by taking the union of all the implementations for a data structure and all the universal implementations, so in the case of the LinkedList above we have</p>

<div class="highlighter-rouge"><pre class="highlight"><code>getNext &lt;- 1
getFirst &lt;- 1
getByIndex &lt;- getFirst + n * getNext
getFirst &lt;- getByIndex
getNext &lt;- getByIndex
reduce[f] &lt;- getFirst + n * getNext + n * f
</code></pre>
</div>

<p>We want to end up with a map from methods to their final cost. To do this, we will basically graph search over our <code class="highlighter-rouge">Set[Impl]</code>. The code for that search looks something like this (real version <a href="https://github.com/bshlgrs/data-structure-composer/blob/cf5b29d5610cc7633ac86f40dabe697afef2f206/src/main/scala/implementationSearcher/Searcher.scala#L23-L68">here</a>):</p>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code><span class="k">def</span> <span class="n">getAllTimes</span><span class="o">(</span><span class="n">implementations</span><span class="k">:</span> <span class="kt">Set</span><span class="o">[</span><span class="kt">Impl</span><span class="o">])</span><span class="k">:</span> <span class="kt">MethodTimes</span> <span class="o">=</span> <span class="o">{</span>
  <span class="k">val</span> <span class="n">result</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">MethodTimes</span><span class="o">()</span>
  <span class="k">val</span> <span class="n">queue</span> <span class="k">=</span> <span class="n">mutable</span><span class="o">.</span><span class="nc">PriorityQueue</span><span class="o">[</span><span class="kt">BoundImpl</span><span class="o">](</span><span class="n">implementations</span><span class="o">.</span><span class="n">filter</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">hasNoFreeVariables</span><span class="o">))</span>

  <span class="k">while</span> <span class="o">(</span><span class="n">queue</span><span class="o">.</span><span class="n">nonEmpty</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">val</span> <span class="n">impl</span> <span class="k">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">pop</span><span class="o">()</span>

    <span class="c1">// add impl to the result if it isn't already in there
</span>    <span class="k">if</span> <span class="o">(</span><span class="n">result</span><span class="o">.</span><span class="n">implIsUseful</span><span class="o">(</span><span class="n">impl</span><span class="o">))</span> <span class="o">{</span>
      <span class="n">result</span><span class="o">.</span><span class="n">addImpl</span><span class="o">(</span><span class="n">impl</span><span class="o">)</span>

      <span class="n">implementations</span><span class="o">.</span><span class="n">foreach</span><span class="o">((</span><span class="n">neighbor</span><span class="k">:</span> <span class="kt">Impl</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">neighbor</span><span class="o">.</span><span class="n">uses</span><span class="o">(</span><span class="n">impl</span><span class="o">.</span><span class="n">methodProvided</span><span class="o">))</span> <span class="o">{</span>
          <span class="c1">// Take the neighbor, like `getByIndex &lt;- getFirst + n * getNext`
</span>          <span class="c1">// and see if it can be used -- in this case, seeing whether you have
</span>          <span class="c1">// a time for both getFirst and getNext. If so, push it to the queue.
</span>
          <span class="c1">// this can return multiple things in the case of
</span>          <span class="c1">// parameterized implementations
</span>          <span class="n">neighbor</span><span class="o">.</span><span class="n">bind</span><span class="o">(</span><span class="n">result</span><span class="o">).</span><span class="n">map</span><span class="o">((</span><span class="n">boundNeighbor</span><span class="k">:</span> <span class="kt">BoundImpl</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">result</span><span class="o">.</span><span class="n">implIsUseful</span><span class="o">(</span><span class="n">boundNeighbor</span><span class="o">))</span> <span class="o">{</span>
              <span class="n">queue</span><span class="o">.</span><span class="n">push</span><span class="o">(</span><span class="n">boundNeighbor</span><span class="o">)</span>
            <span class="o">}</span>
          <span class="o">})</span>
        <span class="o">}</span>
      <span class="o">})</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="n">result</span>
<span class="o">}</span>
</code></pre>
</div>

<p>The <code class="highlighter-rouge">bind</code> method of Impl only returns a non-empty set if it can substitute out all the free variables in the right hand side of the Impl. For example, <code class="highlighter-rouge">bind</code> will return <code class="highlighter-rouge">getByIndex &lt;- n</code> when called on <code class="highlighter-rouge">getByIndex &lt;- getFirst + n * getNext</code> with a result set containing <code class="highlighter-rouge">getFirst &lt;- 1</code> and <code class="highlighter-rouge">getNext &lt;- 1</code>. But it will never return something like <code class="highlighter-rouge">getByIndex &lt;- getFirst + n</code>.</p>

<p>For non-parameterized implementations, there is always a fastest way of doing them. This isn’t true for parameterized implementations, because different implementations might have different conditions and costs which don’t strictly dominate each other. For example, the implementations</p>

<div class="highlighter-rouge"><pre class="highlight"><code>foo[f] if f.bar &lt;- 1
foo[f] if f.baz &lt;- 1
foo[f] &lt;- n
foo[f] &lt;- f
</code></pre>
</div>

<p>are all useful in different situations, so we want to return all of them.</p>

<p>(In practice, I haven’t needed to use this expressiveness very often, and it does make my code much more complicated. So I think I might regret adding it. I’m not sure yet. Certainly it’s useful to be able to pass conditions around, I’m not so sure it’s important to be able to refer to bound variables in the RHS of your Impl.)</p>

<h4 id="composing-data-structures">Composing data structures</h4>

<p>When you have a composite data structure, you only have to run your read methods on one of the data structures, but you have to run your write methods on all of them.</p>

<p>However, the write methods of one data structure can rely on read methods of another. Consider again the single Int which we can use to maintain the sum of a list. On its own, it doesn’t support deletion methods like <code class="highlighter-rouge">deleteLast</code>. But if it is paired with an ArrayList, it can use the <code class="highlighter-rouge">getLast</code> method of the ArrayList to find out what it needs to subtract.</p>

<p>So we end up with code approxiately like this (<a href="https://github.com/bshlgrs/data-structure-composer/blob/d18a104400e214e589cefb72f8d466b97ae44c5f/src/main/scala/implementationSearcher/Searcher.scala#L83-L103">real version here</a>):</p>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code><span class="k">def</span> <span class="n">getAllTimesForDataStructures</span><span class="o">(</span><span class="n">dataStructures</span><span class="k">:</span> <span class="kt">Set</span><span class="o">[</span><span class="kt">DataStructure</span><span class="o">])</span><span class="k">:</span> <span class="kt">MethodTimes</span> <span class="o">=</span> <span class="o">{</span>
  <span class="c1">// for the read methods, union everything provided by the data structures
</span>  <span class="c1">// with the defaultReadImpls, then search for times with it
</span>  <span class="k">val</span> <span class="n">allReadTimes</span> <span class="k">=</span> <span class="n">getAllTimes</span><span class="o">(</span><span class="n">dataStructures</span><span class="o">.</span><span class="n">flatMap</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">readImpls</span><span class="o">)</span> <span class="o">++</span> <span class="n">defaultReadImpls</span><span class="o">)</span>

  <span class="c1">// calculate all write times separately
</span>  <span class="k">val</span> <span class="n">writeTimesForDataStructures</span> <span class="k">=</span> <span class="n">dataStructures</span><span class="o">.</span><span class="n">flatMap</span><span class="o">((</span><span class="n">ds</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="o">{</span>
    <span class="n">getAllTimes</span><span class="o">(</span><span class="n">ds</span><span class="o">.</span><span class="n">writeImpls</span> <span class="o">++</span> <span class="n">allReadTimes</span><span class="o">)</span>
  <span class="o">})</span>

  <span class="c1">// add them to each other
</span>  <span class="k">val</span> <span class="n">overallWriteTimes</span> <span class="k">=</span> <span class="n">writeTimesForDataStructures</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reduce</span><span class="o">(</span><span class="k">_</span> <span class="n">leastUpperBound</span> <span class="k">_</span><span class="o">)</span>

  <span class="n">allReadTimes</span> <span class="o">++</span> <span class="n">overallWriteTimes</span>
<span class="o">}</span>
</code></pre>
</div>

<p>And now we can find optimally fast composite data structures!</p>

<p>Parameterizated data structures work very nicely with this, albeit in a slightly counterintuitive way. Basically, during the search we ignore the fact that an <code class="highlighter-rouge">InvertibleReductionMemoizer[f]</code> has to actually choose a single value of <code class="highlighter-rouge">f</code>; we let everyone use the <code class="highlighter-rouge">reduce[f]</code> Impl without reservation. At the end of the search, we can figure out how many different instances of <code class="highlighter-rouge">InvertibleReductionMemoizer</code> we actually need: perhaps we need one for <code class="highlighter-rouge">getSum</code> and one for <code class="highlighter-rouge">getXor</code> or whatever other implementation we wanted to memoize. The number of instances of a data structure that we require only affects our write times by a constant multiple, so it’s irrelevant for the search we’re doing here.</p>

<p>The main other complexity is that the search needs to maintain its paths: we want to be able to know which data structures were used for which methods. This is maintained by storing this source information and passing it around with the implementations throughout.</p>

<h3 id="optimizations">Optimizations</h3>

<p>One obvious problem with this is that there are exponentially many potential composite data structures to look at. So I use some simple heuristics to cut down the number of composite data structures that I actually consider.</p>

<p>Firstly, data structures are only considered if they have a read method which could plausibly help with the implementation of one of the read methods in the ADT. “Could plausibly help” is determined by considering the directed graph formed by turning an Impl like <code class="highlighter-rouge">f &lt;- g + h</code> into the edges <code class="highlighter-rouge">g -&gt; f</code> and <code class="highlighter-rouge">h -&gt; f</code>–if there’s a path in that graph from <code class="highlighter-rouge">x</code> to <code class="highlighter-rouge">y</code>, a data structure providing <code class="highlighter-rouge">x</code> could plausibly help with an ADT requiring <code class="highlighter-rouge">y</code>. This usually cuts off half of the 15-or-so data structures I have, which makes things like 50 times faster. <a href="https://github.com/bshlgrs/data-structure-composer/blob/d18a104400e214e589cefb72f8d466b97ae44c5f/src/main/scala/implementationSearcher/ImplLibrary.scala#L55">This logic lives here.</a></p>

<p>Secondly, when searching through subsets, if I figure out method times for the set of data structures <script type="math/tex">\{A, B, C\}</script> and I’m considering looking at the set <script type="math/tex">\{A, B, C, D\}</script>, I look at whether any of the implementations provided by <script type="math/tex">D</script> are useful given the result of <script type="math/tex">\{A, B, C\}</script>. If not I don’t explore any subsets including all of <script type="math/tex">\{A, B, C, D\}</script>. <a href="https://github.com/bshlgrs/data-structure-composer/blob/d18a104400e214e589cefb72f8d466b97ae44c5f/src/main/scala/implementationSearcher/Searcher.scala#L118-L119">Here’s the source</a>. This makes things a few times faster.</p>

<p>I also cache results of calls to <code class="highlighter-rouge">getAllTimes</code>. If I’ve established that the read method <code class="highlighter-rouge">foo</code> takes <script type="math/tex">\log(n)</script> time for the set <script type="math/tex">\{A, B, C\}</script>, then I can immediately put the Impl <code class="highlighter-rouge">foo &lt;- log(n)</code> into the queue when running the search on <script type="math/tex">\{A, B, C, D\}</script>. I am not sure if this improves efficiency.</p>

<h2 id="deployment">Deployment</h2>

<p>The code is deployed as a Finagle server with a React app in front. The React app can display useful information about the internals of composite data structures.</p>

<p>I tried compiling my search code to ScalaJS, but it was too slow to be a pleasant experience. If my code was like 10x faster it would be alright.</p>

<h2 id="further-work">Further work</h2>

<p>Here are things I want to do:</p>

<ul>
  <li>Generate real code. The result already has all the information we need to generate code, I just haven’t put in the effort to make it work yet.</li>
  <li>Acquire users. I plan to use this to answer lots of questions on Quora etc, to get people to look at it, and hopefully people will start using it more regularly.</li>
  <li>Consider other optimizations. I added in a bunch of cruft in the final push before the conference presentation, and it’s possible that some refactoring might speed things up.</li>
  <li>Distinguish between different concepts like average case time, worst case time, and amortized time.</li>
  <li>Instead of minimizing asymptotic time, I could instead get an empirical measure of the speed of different methods in different data structures, and choose the fastest data structures for a given expected data set size using those measurements. This works best with the approach where we are generating real code with real data structure implementations.</li>
  <li>Extend to talk about other types of queries. In particular, I could try to support more SQL-style queries on multi-column data.</li>
</ul>

<h2 id="conclusion">Conclusion</h2>

<p>How useful could a tool like this be? I don’t know. A lot of data structure research can’t yet be fit nicely into the framework of things I can describe with this system.</p>

<p>I also find that writing data structures down for this project forced me to think about them and write down facts about them that aren’t usually said. For example, the <a href="http://www.geeksforgeeks.org/range-minimum-query-for-static-array/">sparse table</a> data structure for <a href="https://en.wikipedia.org/wiki/Range_minimum_query">range minimum query</a> is usually not described as letting you push things on the end in amortized <script type="math/tex">O(\log(n))</script>, even though you can obviously do that by resizing exponentially. This forced clarity is really useful.</p>

<p>Overall the practical usefulness of this project remains to be seen. It was a lot of fun to build though.</p>

<p>Thanks heaps to everyone who helped me out as I was writing this.</p>

<h2 id="appendix-how-long-did-i-spend-on-this">Appendix: how long did I spend on this?</h2>

<p>According to RescueTime, I’ve spend 94 hours in IntelliJ this year. Almost all of that time was spent working on this project. A lot of the time I spent working on this project is not included in that number: the frontend was written using Sublime Text, and I had to spend a lot of time thinking in front of a whiteboard, and I spent the usual amount of time on StackOverflow or in a terminal.</p>

<p>My subjective experience is that I spent a bunch of time on this on most of my weekends and many of my evenings for the past two months. If I did on average four hours of work on each weekend day and ten hours of work over the week, that’s 14 hours a week times 8 weeks = 112 hours. I also took off two days from work to work entirely on this, and got about 8 hours done on each of those days.</p>

<p>When I feel like I am working on my software, I also often end up reading Facebook or whatever for 25% of the time. So the 94 hours I spent in IJ probably also involved spending an extra 30 on the internet.</p>

<p>My overall guess is that I spent between 150 and 200 hours on this project.</p>

    </div>
  </div>


<p><a href="/posts">All posts</a></p>

<p><a href="/feed.xml">RSS feed</a></p>

<script>
$(function() {
  $(".shrink-headings").map(function(idx, div) {
    $(div).html(
      $(div)
        .html()
        .replace(/<h4/g, "<h5")
        .replace(/<h3/g, "<h4")
        .replace(/<h2/g, "<h3")
    )
  })
})
</script>


      <hr/>

      <div class="PageNavigation">
        
        
      </div>

    </div>

    <div class="col-sm-3 visible-xs-block">
      <img src="/img/dual_n_buck.jpeg" class="img-responsive" alt="Picture of Buck" height="213" width="213">
<hr/>
<a class="arrow" href="/"><strong>Buck</strong></a>
<ul>
  <li><a class="arrow" href="/about">About</a>
    <ul>
      <li><a href="http://triplebyte.com?ref=shlegeris.com">Triplebyte</a></li>
    </ul>
  </li>
  <li>Links
    <ul>
      <li>
          <a class="arrow" href="http://github.com/bshlgrs">GitHub</a>
      </li>
      <li>
          <a class="arrow" href="mailto:bshlegeris@gmail.com">Email</a>
      </li>
      <li>
          <a class="arrow" href="http://www.facebook.com/bshlgrs">Facebook</a>
      </li>
      <li>
          <a class="arrow" href="http://lnkd.in/bnBJ6EF">LinkedIn</a>
      </li>
    </ul>
  </li>
  <li><a class="arrow external" href="/anonymous_feedback">Anonymous feedback</a></li>
  <li>Software to play with
    <ul>
      <li>
          <a class="arrow" href="http://ds.shlegeris.com/">Data structure search engine</a>
      </li>
      <li>
          <a class="arrow" href="https://bshlgrs.github.io/music-game/">Relative pitch game</a>
      </li>
      <li>
          <a class="arrow" href="http://shlegeris.com/gini">Gini coefficient tool</a>
      </li>
      <li>
          <a class="arrow" href="http://shlegeris.com/dice">Extremely serious election probability tool</a>
      </li>
    </ul>
  </li>
  <li><a href="/posts" class="arrow">Blog</a> (<a href="/best" class="arrow">Best posts</a>) (<a href="/feed.xml">RSS</a>)
    <ul>
      
        <li>
          <a class="arrow" href="/2016/11/26/research.html">How much of a paperclip maximizer's resources should be spend on research?</a>
        </li>
      
        <li>
          <a class="arrow" href="/2016/11/13/phd.html">Advice on whether you should get a PhD in engineering</a>
        </li>
      
        <li>
          <a class="arrow" href="/2016/11/13/ds.html">Building a search engine for data structures</a>
        </li>
      
        <li>
          <a class="arrow" href="/2016/10/23/poor-college-graduates.html">Poor college graduates do much better than rich high-school dropouts</a>
        </li>
      
        <li>
          <a class="arrow" href="/2016/10/20/libertarians.html">Left-libertarianism</a>
        </li>
      
        <li>
          <a class="arrow" href="/2016/10/07/optimal-tax.html">Optimal redistribution with a flat tax</a>
        </li>
      
        <li>
          <a class="arrow" href="/2016/10/02/ubi.html">Universal basic incomes disincentivise work</a>
        </li>
      
        <li>
          <a class="arrow" href="/2016/10/02/tax.html">The great thing about regressive taxes</a>
        </li>
      
    </ul>
  </li>
  <li>
      <a class="arrow" href="/to-prove-list">My "to-prove" list</a>
  </li>
  <li>
      <a class="arrow" href="/mistakes">Mistakes</a>
  </li>
  <li>
      <a class="arrow" href="/cute">Pictures of me</a>
  </li>
</ul>

    </div>
  </div>
</div>




    <footer class="site-footer">

  <div class="wrapper">

    <h2 class="footer-heading">Buck Shlegeris</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li>Buck Shlegeris</li>
          <li><a href="mailto:bshlegeris@gmail.com">bshlegeris@gmail.com</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/bshlgrs"><span class="icon icon--github"><svg viewBox="0 0 16 16"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/></svg>
</span><span class="username">bshlgrs</span></a>

          </li>
          

          
          <li>
            <a href="https://twitter.com/bshlgrs"><span class="icon icon--twitter"><svg viewBox="0 0 16 16"><path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/></svg>
</span><span class="username">bshlgrs</span></a>

          </li>
          
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p>Website of Buck Shlegeris.
</p>
      </div>
    </div>

  </div>

</footer>


  </body>
<script>
if (window.location.hostname == "bshlgrs.github.io") {
  window.location.hostname = "shlegeris.com";
}
</script>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-52980069-1', 'auto');
  ga('send', 'pageview');

</script>

</html>

